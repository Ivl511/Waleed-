<script>
lucide.createIcons();

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileStatus = document.getElementById('file-status');
const startBtn = document.getElementById('start-btn');
const uploadSection = document.getElementById('upload-section');
const standardsSection = document.getElementById('standards-section');
const loadingSection = document.getElementById('loading-section');
const resultSection = document.getElementById('result-section');
const resetBtn = document.getElementById('reset-btn');

let selectedFiles = [];

dropZone.onclick = () => fileInput.click();

fileInput.onchange = (e) => {
    selectedFiles = e.target.files;
    if (selectedFiles.length > 0) {
        fileStatus.textContent = `تم اختيار ${selectedFiles.length} صور بجودة عالية`;
        fileStatus.classList.remove('hidden');
    }
};

// دالة تحليل الصورة باستخدام Hugging Face API
async function analyzeImage(file) {
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('https://api-inference.huggingface.co/models/your-model-name', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer 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' },
        body: formData
    });
    if (!response.ok) throw new Error('فشل تحليل الصورة');
    return await response.json();
}

// تحليل جميع الصور المرفوعة مباشرة
async function analyzeAllImages(files) {
    const results = [];
    for (let i = 0; i < files.length; i++) {
        const res = await analyzeImage(files[i]);
        results.push(res);
    }
    return results;
}

startBtn.onclick = async () => {
    if (selectedFiles.length === 0) {
        alert('الرجاء رفع صورة واحدة على الأقل للبدء');
        return;
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
    uploadSection.classList.add('hidden');
    standardsSection.classList.add('hidden');
    loadingSection.classList.remove('hidden');

    try {
        // تحليل كل الصور دفعة واحدة
        const results = await analyzeAllImages(selectedFiles);
        console.log(results); // النتائج من API لاستخدامها لاحقاً

        // بعد التحليل نعرض النتائج
        loadingSection.classList.add('hidden');
        resultSection.classList.remove('hidden');

        document.getElementById('success-details').classList.remove('hidden');
        document.getElementById('male-error').classList.add('hidden');
        document.getElementById('final-score').parentElement.classList.remove('hidden');
        document.getElementById('score-note').classList.remove('hidden');

        // حساب متوسط النتيجة لجميع الصور (كمثال)
        const score = Math.round(results.reduce((acc, r) => acc + (r.score || 80), 0) / results.length);
        document.getElementById('final-score').textContent = score;
        document.getElementById('score-note').textContent = score > 90 ? "ما شاء الله، فردية فاخرة من صفوة الصفوة" : "فردية طيبة وتنافس بقوة في المزاين";

        // يمكنك هنا تعديل pros و cons بناء على النتائج الفعلية من API
        const pros = [
            "الرأس طافح وعرنونها مشدود بشكل مثالي",
            "الرقبة جرداء وطويلة وتبرز شموخها الاستثنائي",
            "السنام رادم وفي موقعه الصحيح المتأخر بوضوح",
            "السبال ضافية ومتدلية بجمال لافت وأصيل"
        ];
        const cons = [
            "الرقبة تحتاج زيادة طول يسيرة لتكون أكثر تناسقاً",
            "السنام متقدم قليلاً عن الموقع المثالي المعتمد"
        ];

        const prosList = document.getElementById('pros-list');
        prosList.innerHTML = pros.map(p => `
            <li class="flex items-start gap-4 bg-green-50/80 p-6 rounded-[2rem] border border-green-100 shadow-sm hover:scale-105 transition-transform">
                <i data-lucide="check" class="w-6 h-6 text-green-600 mt-1 flex-shrink-0"></i>
                <span class="text-gray-800 font-bold text-xl">${p}</span>
            </li>
        `).join('');

        const consList = document.getElementById('cons-list');
        consList.innerHTML = cons.map(c => `
            <li class="flex items-start gap-4 bg-amber-50/80 p-6 rounded-[2rem] border border-amber-100 shadow-sm hover:scale-105 transition-transform">
                <i data-lucide="alert-circle" class="w-6 h-6 text-amber-600 mt-1 flex-shrink-0"></i>
                <span class="text-gray-800 font-bold text-xl">${c}</span>
            </li>
        `).join('');

        lucide.createIcons();

    } catch (err) {
        alert('حدث خطأ أثناء تحليل الصورة: ' + err.message);
        uploadSection.classList.remove('hidden');
        standardsSection.classList.remove('hidden');
        loadingSection.classList.add('hidden');
    }
};

resetBtn.onclick = () => {
    resultSection.classList.add('hidden');
    uploadSection.classList.remove('hidden');
    standardsSection.classList.remove('hidden');
    fileInput.value = '';
    fileStatus.classList.add('hidden');
    selectedFiles = [];
    window.scrollTo({ top: 0, behavior: 'smooth' });
};
</script>
